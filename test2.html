<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="Generator" content="EditPlus®">
  <meta name="Author" content="">
  <meta name="Keywords" content="">
  <meta name="Description" content="">
  <title>Document</title>
  <script type="text/javascript" src="/js/jquery.1.12.4.min.js"></script>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <style>
      input,td {width:12.8em;}      
  </style>
 </head>
 <body>
  <div>
      <table id="b2b_multi">
          <thead>
              <th>선택</th>
              <th>번호</th>
              <th>이름</th>
              <th>영문이름</th>
              <th>주민등록번호</th>
              <th>(만)나이</th>
              <th>플랜</th>
              <th>보험료</th>
          </thead>
          <tbody>
            <tr>
                <td><input type="checkbox" name="nob[]"></td>
                <td>1</td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
            </tr>
            <tr>
                <td><input type="checkbox" name="nob[]"></td> 
                <td>2</td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
            </tr>
            <tr>
                <td><input type="checkbox" name="nob[]"></td>
                <td>3</td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="juminno[]" value=""></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
            </tr>
            <tr>
                <td><input type="checkbox" name="nob[]"></td>
                <td>4</td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="juminno[]" value=""></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
            </tr>
            <tr>
                <td><input type="checkbox" name="nob[]"></td>
                <td>5</td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="juminno[]" value=""></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
            </tr>
            <tr>
                <td><input type="checkbox" name="nob[]"></td>
                <td>6</td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="juminno[]" value=""></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
            </tr>
            <tr>
                <td><input type="checkbox" name="nob[]"></td>
                <td>7</td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="" value=""></td>
                <td><input type="text" name="juminno[]" value=""></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
            </tr>    
          </tbody>      
      </table>
  </div>
  <div>
      <div class="col-sm-2"><button type="button" id="plusbt">증가</button type="button"></div>
      <div class="col-sm-2"><button type="button" id="allbt">전체선택</button></div>
      <div class="col-sm-2"><button type="button" id="allnbt">전체해제</button></div>
      <div class="col-sm-2"><button type="button" id="seldbt">선택삭제</button></div>
  </div>
 </body>
<script type="text/javascript">
$(document).ready(function(){
    $('#plusbt').on('click',function(){
        
        var copy_tr = $('#b2b_multi').find('tbody tr:lt(3)').clone();
        copy_tr.find('input').val('');
       copy_tr.find('input[type="checkbox"]').prop('checked',false);
        $('#b2b_multi').append(copy_tr);
        prt_no();
    });

    $('#allbt').on('click',function(){
        $('input[name="nob[]"]').prop('checked', true);
    });

    $('#allnbt').on('click',function(){
        $('input[name="nob[]"]').prop('checked', false);
    });

    $('#seldbt').on('click',function(){
        var t_cnt = $('input[name="nob[]"]').length;
        var ch_t_cnt = 0;
        var ch_re_cnt = 0;
        $('input[name="nob[]"]').each(function(ind,val){           
            if($('input[name="nob[]"]').eq(ind).is(':checked')){                
                ch_t_cnt++;                    
            }        
        });

        if(ch_t_cnt < 1){
            alert('선택된 데이터가 없습니다.');
            return false;
        }

        if(ch_t_cnt === t_cnt){
            alert('전체삭제');
            $('input[name="nob[]"]').each(function(ind,val){           
                if($('input[name="nob[]"]').eq(ind).is(':checked')){           
                    $('input[name="nob[]"]').closest('tr').eq(ind).find('input').val('');
                    $('input[name="nob[]"]').eq(ind).prop('checked',false);
                }        
            });
        } else {
            var remove_no = new Array();
            $('input[name="nob[]"]').each(function(ind,val){  
                
                if($('input[name="nob[]"]').eq(ind).is(':checked')){                     
                    ch_re_cnt++;  
                    //$('input[name="nob[]"]:checked').closest('tr').remove();
                    remove_no.push(ind); 
                }        
            });
            $('input[name="nob[]"]').each(function(ind,val){      
                if($('input[name="nob[]"]').eq(ind).is(':checked')){                
                    $('input[name="nob[]"]:checked').closest('tr').remove();         
                }   
            });    
            
            var repair_tr = ch_re_cnt;
           
            for(i=0; i < repair_tr; i++){
                var copy_cre_tr = $('#b2b_multi').find('tbody tr:eq(0)').clone();
                copy_cre_tr.find('input').val('');
                copy_cre_tr.find('input[type="checkbox"]').prop('checked',false);
                $('#b2b_multi').append(copy_cre_tr);    
            }

        }
        prt_no();
    });

    //$('input').on('paste',function(e){ 
        /*일반적으로 function을 실행 시키고 싶다면 
        위의 on을 
        동적(clone)으로 생성하는 경우라면 아래처럼
    */    
    $(document).on('paste', 'input', function(e){
            var $this= $(this);
            var pasted;
            var cccc;
            var bbbb;
            if (window.clipboardData && window.clipboardData.getData) { 
        /** ie 용 **/
        pasted = window.clipboardData.getData('Text');
        pasted = pasted.trim('\r\n');
        bbbb = pasted.split('\r\n');
        cccc = bbbb[0].split('\t');
        e.stopPropagation();
        e.preventDefault();   
    } else if (e.originalEvent.clipboardData.getData) {
        /** 그이외 **/
        
        pasted = e.originalEvent.clipboardData.getData('text/plain');
        pasted = pasted.trim('\r\n');
        bbbb = pasted.split('\r\n');
        cccc = bbbb[0].split('\t');
        //console.log(cccc);
        e.stopPropagation();
        e.preventDefault();    
        
    }
    var kk = $this.closest('td').index();
    var mm = $this.closest('td').length;
    var verrown = $this.closest('tr').index();
    var obj = {};
    console.log("선택된 td주소 - input:"+kk+"클립보드 col수"+cccc.length);
    var limit_td = 4;
    if((kk+(cccc.length - 1)) > limit_td){
        alert('복사할 데이터가 셀보다 큽니다.');
        return false;
    } else {        
        var rejectno = 0;
        $.each(pasted.split('\r\n'), function(indy, valuy){
                $.each(valuy.split('\t'),function(indx, valux){
                    var row = verrown+indy, col = kk+indx;
                            obj['cell-'+row+'-'+col] = valux;
                            valux = valux.trim();
                            $this.closest('table').find('tr:eq('+(row+1)+') td:eq('+col+') input').val(valux);     

                            if(col == 4){
                                console.log('지정된 col : '+ju_chk(valux));

                                if( ju_chk(valux) < 1){
                                    age_calcultor(valux, row, col);  
                                    $this.closest('table').find('tr:eq('+(row+1)+') td:eq('+col+')').css('border', '');
                                } else {
                                    $this.closest('table').find('tr:eq('+(row+1)+') td:eq('+col+')').css('border', '1px dotted red');
                                    $this.closest('table').find('tr:eq('+(row+1)+') td:eq('+(col+1)+') input').val('');
                                    rejectno = rejectno + 1;
                                }
                            }
                             
                });
        });
        if(rejectno > 0){
            alert('적합하지않는 주민번호가 있습니다.');
            return false;
        }    
        $('#viewprt').text(JSON.stringify(obj));
      
    }

        });

});

function prt_no(){
    //table tr이 증가하면 숫자를 다시 지정한다.
    var cnt= 1;
    $('#b2b_multi tr').each(function(ind){
       
        $('#b2b_multi tbody tr:eq('+ind+') td:eq(1)').text(cnt);
        cnt++;
    });

}

function age_calcultor(kind,rown, coln){
        
        var cage;
       // $('input[name="juminno[]"]').each(function(ind, vale){
            //cage = $(vale).attr('value');
            cage = kind;
            
            //var result_age = cage.split("-");

            $.post('./age_cal.php', {tyear:cage}, function (data){			
            if(data.msg){			
                //location.replace(data.Locate);
                console.log(data.msg['1']);
                //$('input[name="juminno[]').eq(coln).closest('td').next('td').contents().filter(function(){return this.nodeType == 3}).remove().end();    

                //$('input[name="juminno[]').eq(coln).closest('td').next('td').append(data.msg['1']).end();    
                //$('input[name="juminno[]').eq(coln).closest('td').next('td').children('input').val(data.msg['1']).end(); 
                $('#b2b_multi').find('tr:eq('+(rown+1)+') td:eq('+(coln+1)+') input').val(data.msg['1']).end(); 
            } else {
                alert('안됐다');
            }			

            },"json").done(function(){
            
            
            }).fail(function(){
            
            });
        //});
    }

    function ju_chk(kind){
        var junum = kind.split("-");
        var jumins3 = junum[0]+junum[1];
         //주민등록번호 생년월일 전달
          var fmt = RegExp(/^\d{6}[1234]\d{6}$/);//포멧 설정
          var buf = new Array(13); 
          var errorcnt = 0;
          //주민번호 유효성 검사 
          if (!fmt.test(jumins3)) { 
              //alert("주민등록번호 형식에 맞게 입력해주세요");
               //$("#id_num").focus(); 
               //return false; 
               errorcnt  = errorcnt + 1;
               console.log("에러 1"+errorcnt);
            } 
            
            //주민번호 존재 검사 
        for (var i = 0; i < buf.length; i++){
             buf[i] = parseInt(jumins3.charAt(i)); 
        } 
        
        var multipliers = [2,3,4,5,6,7,8,9,2,3,4,5];// 밑에 더해주는 12자리 숫자들
         var sum = 0; 
         for (var i = 0; i < 12; i++){
              sum += (buf[i] *= multipliers[i]);// 배열끼리12번 돌면서 
        }

        if ((11 - (sum % 11)) % 10 != buf[12]) { 
            //alert("잘못된 주민등록번호 입니다.");
            //$("#id_num").focus();
             //return false; 
             errorcnt  = errorcnt + 1;
             console.log("에러 2"+errorcnt);
        }
        return errorcnt;
    }
</script>
</html>
